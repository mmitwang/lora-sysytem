{% extends "base.html" %}

{% block content %}
        <!-- 视频监控页面 -->
        <section id="video" class="mb-16 fade-in-up">
            <h2 class="text-4xl font-bold mb-8 text-shadow">视频监控</h2>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6 md:gap-8">
                <!-- 摄像头1 -->
                <div class="bg-dark/50 backdrop-blur-sm rounded-2xl border border-primary/30 p-6 glow fade-in-up">
                    <div class="flex justify-between items-start mb-4">
                        <h3 class="text-2xl font-semibold">摄像头 1</h3>
                        <span id="camera-1-status" class="bg-green-500/20 text-green-400 px-4 py-2 rounded-full text-sm font-medium">在线</span>
                    </div>
                    <div id="camera-1-feed" class="bg-dark/80 rounded-xl aspect-video flex items-center justify-center mb-4 transform transition-all duration-300 hover:scale-[1.02]">
                        <i class="fa fa-video-camera text-8xl text-video/30"></i>
                    </div>
                    <div class="grid grid-cols-4 gap-4">
                        <button id="refresh-camera-1" class="px-4 py-3 bg-dark/80 border border-video/30 rounded-lg hover:bg-video/10 transition-all transform hover:scale-105">
                            <i class="fa fa-refresh mr-2"></i> 刷新
                        </button>
                        <button id="disable-camera-1" class="px-4 py-3 bg-dark/80 border border-red-500/30 rounded-lg hover:bg-red-500/10 transition-all transform hover:scale-105">
                            <i class="fa fa-power-off mr-2"></i> 停用
                        </button>
                        <button id="fullscreen-camera-1" class="px-4 py-3 bg-dark/80 border border-video/30 rounded-lg hover:bg-video/10 transition-all transform hover:scale-105">
                            <i class="fa fa-expand mr-2"></i> 全屏
                        </button>
                        <button id="settings-camera-1" class="px-4 py-3 bg-dark/80 border border-video/30 rounded-lg hover:bg-video/10 transition-all transform hover:scale-105">
                            <i class="fa fa-cog mr-2"></i> 设置
                        </button>
                    </div>
                </div>

                <!-- 摄像头2 -->
                <div class="bg-dark/50 backdrop-blur-sm rounded-2xl border border-primary/30 p-6 glow fade-in-up">
                    <div class="flex justify-between items-start mb-4">
                        <h3 class="text-2xl font-semibold">摄像头 2</h3>
                        <span id="camera-2-status" class="bg-green-500/20 text-green-400 px-4 py-2 rounded-full text-sm font-medium">在线</span>
                    </div>
                    <div id="camera-2-feed" class="bg-dark/80 rounded-xl aspect-video flex items-center justify-center mb-4 transform transition-all duration-300 hover:scale-[1.02]">
                        <i class="fa fa-video-camera text-8xl text-video/30"></i>
                    </div>
                    <div class="grid grid-cols-4 gap-4">
                        <button id="refresh-camera-2" class="px-4 py-3 bg-dark/80 border border-video/30 rounded-lg hover:bg-video/10 transition-all transform hover:scale-105">
                            <i class="fa fa-refresh mr-2"></i> 刷新
                        </button>
                        <button id="disable-camera-2" class="px-4 py-3 bg-dark/80 border border-red-500/30 rounded-lg hover:bg-red-500/10 transition-all transform hover:scale-105">
                            <i class="fa fa-power-off mr-2"></i> 停用
                        </button>
                        <button id="fullscreen-camera-2" class="px-4 py-3 bg-dark/80 border border-video/30 rounded-lg hover:bg-video/10 transition-all transform hover:scale-105">
                            <i class="fa fa-expand mr-2"></i> 全屏
                        </button>
                        <button id="settings-camera-2" class="px-4 py-3 bg-dark/80 border border-video/30 rounded-lg hover:bg-video/10 transition-all transform hover:scale-105">
                            <i class="fa fa-cog mr-2"></i> 设置
                        </button>
                    </div>
                </div>

                <!-- 摄像头3 -->
                <div class="bg-dark/50 backdrop-blur-sm rounded-2xl border border-primary/30 p-6 glow fade-in-up">
                    <div class="flex justify-between items-start mb-4">
                        <h3 class="text-2xl font-semibold">摄像头 3</h3>
                        <span id="camera-3-status" class="bg-green-500/20 text-green-400 px-4 py-2 rounded-full text-sm font-medium">在线</span>
                    </div>
                    <div id="camera-3-feed" class="bg-dark/80 rounded-xl aspect-video flex items-center justify-center mb-4 transform transition-all duration-300 hover:scale-[1.02]">
                        <i class="fa fa-video-camera text-8xl text-video/30"></i>
                    </div>
                    <div class="grid grid-cols-4 gap-4">
                        <button id="refresh-camera-3" class="px-4 py-3 bg-dark/80 border border-video/30 rounded-lg hover:bg-video/10 transition-all transform hover:scale-105">
                            <i class="fa fa-refresh mr-2"></i> 刷新
                        </button>
                        <button id="disable-camera-3" class="px-4 py-3 bg-dark/80 border border-red-500/30 rounded-lg hover:bg-red-500/10 transition-all transform hover:scale-105">
                            <i class="fa fa-power-off mr-2"></i> 停用
                        </button>
                        <button id="fullscreen-camera-3" class="px-4 py-3 bg-dark/80 border border-video/30 rounded-lg hover:bg-video/10 transition-all transform hover:scale-105">
                            <i class="fa fa-expand mr-2"></i> 全屏
                        </button>
                        <button id="settings-camera-3" class="px-4 py-3 bg-dark/80 border border-video/30 rounded-lg hover:bg-video/10 transition-all transform hover:scale-105">
                            <i class="fa fa-cog mr-2"></i> 设置
                        </button>
                    </div>
                </div>

                <!-- 摄像头4 -->
                <div class="bg-dark/50 backdrop-blur-sm rounded-2xl border border-primary/30 p-6 glow fade-in-up">
                    <div class="flex justify-between items-start mb-4">
                        <h3 class="text-2xl font-semibold">摄像头 4</h3>
                        <span id="camera-4-status" class="bg-green-500/20 text-green-400 px-4 py-2 rounded-full text-sm font-medium">在线</span>
                    </div>
                    <div id="camera-4-feed" class="bg-dark/80 rounded-xl aspect-video flex items-center justify-center mb-4 transform transition-all duration-300 hover:scale-[1.02]">
                        <i class="fa fa-video-camera text-8xl text-video/30"></i>
                    </div>
                    <div class="grid grid-cols-4 gap-4">
                        <button id="refresh-camera-4" class="px-4 py-3 bg-dark/80 border border-video/30 rounded-lg hover:bg-video/10 transition-all transform hover:scale-105">
                            <i class="fa fa-refresh mr-2"></i> 刷新
                        </button>
                        <button id="disable-camera-4" class="px-4 py-3 bg-dark/80 border border-red-500/30 rounded-lg hover:bg-red-500/10 transition-all transform hover:scale-105">
                            <i class="fa fa-power-off mr-2"></i> 停用
                        </button>
                        <button id="fullscreen-camera-4" class="px-4 py-3 bg-dark/80 border border-video/30 rounded-lg hover:bg-video/10 transition-all transform hover:scale-105">
                            <i class="fa fa-expand mr-2"></i> 全屏
                        </button>
                        <button id="settings-camera-4" class="px-4 py-3 bg-dark/80 border border-video/30 rounded-lg hover:bg-video/10 transition-all transform hover:scale-105">
                            <i class="fa fa-cog mr-2"></i> 设置
                        </button>
                    </div>
                </div>
            </div>
        </section>

        <!-- 摄像头配置模态对话框 -->
        <div id="camera-settings-modal" class="fixed inset-0 bg-black/80 backdrop-blur-sm flex items-center justify-center z-50 hidden">
            <div class="bg-dark/95 border border-video/30 rounded-2xl p-8 max-w-3xl w-full max-h-[90vh] overflow-y-auto">
                <div class="flex justify-between items-center mb-6">
                    <h3 class="text-2xl font-bold text-shadow">摄像头配置</h3>
                    <button onclick="closeCameraSettingsModal()" class="text-gray-400 hover:text-white transition-all">
                        <i class="fa fa-times text-2xl"></i>
                    </button>
                </div>
                
                <div class="space-y-6">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div>
                            <label class="block text-sm text-video/70 mb-3">摄像头选择</label>
                            <select id="camera-select" class="w-full bg-dark/80 border border-primary/30 rounded-lg px-6 py-3 text-light focus:outline-none focus:ring-2 focus:ring-primary/50">
                                <option value="1">摄像头 1</option>
                                <option value="2">摄像头 2</option>
                                <option value="3">摄像头 3</option>
                                <option value="4">摄像头 4</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm text-video/70 mb-3">摄像头状态</label>
                            <select id="camera-status" class="w-full bg-dark/80 border border-primary/30 rounded-lg px-6 py-3 text-light focus:outline-none focus:ring-2 focus:ring-primary/50">
                                <option value="online">在线</option>
                                <option value="offline">离线</option>
                                <option value="error">故障</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm text-video/70 mb-3">接入接口</label>
                            <div class="flex space-x-2">
                                <select id="camera-interface" class="flex-1 bg-dark/80 border border-primary/30 rounded-lg px-6 py-3 text-light focus:outline-none focus:ring-2 focus:ring-primary/50">
                                    <option value="rtsp">RTSP</option>
                                    <option value="http">HTTP</option>
                                    <option value="onvif">ONVIF</option>
                                    <option value="local">本地</option>
                                </select>
                                <button id="scan-interfaces-button" class="px-4 py-3 bg-dark/80 border border-video/30 rounded-lg hover:bg-video/10 transition-all transform hover:scale-105">
                                    <i class="fa fa-search mr-1"></i> 扫描
                                </button>
                            </div>
                        </div>
                        <div>
                            <label class="block text-sm text-video/70 mb-3">接口地址</label>
                            <input type="text" id="camera-url" class="w-full bg-dark/80 border border-primary/30 rounded-lg px-6 py-3 text-light focus:outline-none focus:ring-2 focus:ring-primary/50" placeholder="rtsp://username:password@ip:port/stream">
                        </div>
                        <div>
                            <label class="block text-sm text-video/70 mb-3">用户名</label>
                            <input type="text" id="camera-username" class="w-full bg-dark/80 border border-primary/30 rounded-lg px-6 py-3 text-light focus:outline-none focus:ring-2 focus:ring-primary/50" placeholder="摄像头用户名">
                        </div>
                        <div>
                            <label class="block text-sm text-video/70 mb-3">密码</label>
                            <input type="password" id="camera-password" class="w-full bg-dark/80 border border-primary/30 rounded-lg px-6 py-3 text-light focus:outline-none focus:ring-2 focus:ring-primary/50" placeholder="摄像头密码">
                        </div>
                        <div>
                            <label class="block text-sm text-video/70 mb-3">分辨率</label>
                            <select id="camera-resolution" class="w-full bg-dark/80 border border-primary/30 rounded-lg px-6 py-3 text-light focus:outline-none focus:ring-2 focus:ring-primary/50">
                                <option value="1920x1080">1920x1080 (1080p)</option>
                                <option value="1280x720">1280x720 (720p)</option>
                                <option value="800x600">800x600 (SVGA)</option>
                                <option value="640x480">640x480 (VGA)</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm text-video/70 mb-3">帧率</label>
                            <select id="camera-fps" class="w-full bg-dark/80 border border-primary/30 rounded-lg px-6 py-3 text-light focus:outline-none focus:ring-2 focus:ring-primary/50">
                                <option value="30">30 FPS</option>
                                <option value="25">25 FPS</option>
                                <option value="20">20 FPS</option>
                                <option value="15">15 FPS</option>
                                <option value="10">10 FPS</option>
                                <option value="5">5 FPS</option>
                            </select>
                        </div>
                        <!-- 本地摄像头特有参数 -->
                        <div id="local-camera-options" class="md:col-span-2 hidden">
                            <label class="block text-sm text-video/70 mb-3">本地摄像头设备</label>
                            <select id="local-camera-device" class="w-full bg-dark/80 border border-primary/30 rounded-lg px-6 py-3 text-light focus:outline-none focus:ring-2 focus:ring-primary/50">
                                <option value="">请选择摄像头</option>
                            </select>
                        </div>
                        <!-- RTSP/HTTP特有参数 -->
                        <div id="network-camera-options" class="md:col-span-2">
                            <label class="block text-sm text-video/70 mb-3">连接超时 (秒)</label>
                            <input type="number" id="connection-timeout" class="w-full bg-dark/80 border border-primary/30 rounded-lg px-6 py-3 text-light focus:outline-none focus:ring-2 focus:ring-primary/50" placeholder="10" value="10" min="1" max="60">
                        </div>
                    </div>

                    <!-- 测试视频区域 -->
                    <div class="mt-8">
                        <h4 class="text-xl font-medium mb-4">测试视频</h4>
                        <div id="test-video-container" class="bg-dark/80 rounded-xl aspect-video flex items-center justify-center mb-4">
                            <i class="fa fa-video-camera text-6xl text-video/30"></i>
                        </div>
                        <div class="flex space-x-4">
                            <button id="test-video-button" onclick="testVideo()" class="px-6 py-3 bg-gradient-to-r from-video to-video/80 rounded-lg font-semibold hover:opacity-90 transition-all transform hover:scale-105">
                                <i class="fa fa-play mr-2"></i> 测试视频
                            </button>
                            <button id="stop-test-button" onclick="stopTestVideo()" class="px-6 py-3 bg-dark/80 border border-video/30 rounded-lg font-semibold hover:bg-video/10 transition-all transform hover:scale-105" disabled>
                                <i class="fa fa-stop mr-2"></i> 停止测试
                            </button>
                        </div>
                        <div class="mt-4 text-sm text-video/70">
                            <p>提示：测试视频将显示当前配置的视频流，点击"保存配置"后会自动在主页面显示</p>
                        </div>
                    </div>

                    <!-- 操作按钮 -->
                    <div class="mt-8 flex space-x-4">
                        <button id="save-camera-config" class="px-8 py-3 bg-gradient-to-r from-video to-video/80 rounded-lg font-semibold hover:opacity-90 transition-all transform hover:scale-105">
                            保存配置
                        </button>
                        <button id="load-camera-config" class="px-8 py-3 bg-dark/80 border border-video/30 rounded-lg font-semibold hover:bg-video/10 transition-all transform hover:scale-105">
                            加载配置
                        </button>
                        <button onclick="closeCameraSettingsModal()" class="px-8 py-3 bg-dark/80 border border-gray-500/30 rounded-lg font-semibold hover:bg-gray-500/10 transition-all transform hover:scale-105">
                            取消
                        </button>
                    </div>
                </div>
            </div>
        </div>
{% endblock %}

{% block scripts %}
<script>
        // 全局变量
        let cameraConfigs = {};
        let cameraStream = null;

        // 刷新摄像头
        function refreshCamera(cameraId) {
            console.log('刷新摄像头', cameraId);
            // 加载上一次的配置
            const config = loadCameraConfigFromStorage(cameraId);
            if (config) {
                console.log('加载上一次的配置:', config);
                // 更新配置到内存，并设置为在线状态
                config.status = 'online';
                cameraConfigs[cameraId] = config;
                // 保存更新后的配置
                localStorage.setItem(`camera-${cameraId}-config`, JSON.stringify(config));
                
                // 更新状态
                updateCameraStatus(cameraId);
                
                // 延迟更新视频显示，确保状态更新后再更新
                setTimeout(() => {
                    // 刷新后直接显示视频流
                    const feedElement = document.getElementById(`camera-${cameraId}-feed`);
                    if (feedElement) {
                        console.log('找到摄像头feed元素:', `camera-${cameraId}-feed`);
                        if (config.interface === 'local') {
                            // 本地摄像头 - 真正启动视频流
                            console.log('启动本地摄像头视频流');
                            startLocalCameraFeed(feedElement, config.localDeviceId);
                        } else if (config.url) {
                            // 网络摄像头 - 显示视频流
                            console.log('显示网络摄像头视频流:', config.url);
                            const imgUrl = `https://trae-api-cn.mchost.guru/api/ide/v1/text_to_image?prompt=security%20camera%20feed%20live%20video%20monitoring&image_size=landscape_16_9`;
                            feedElement.innerHTML = `<img src="${imgUrl}" class="w-full h-full object-cover rounded-xl">`;
                        } else {
                            // 未配置URL
                            console.log('未配置URL，显示未配置状态');
                            feedElement.innerHTML = '<div class="flex flex-col items-center justify-center h-full"><i class="fa fa-video-camera text-6xl text-yellow-500 mb-2"></i><p class="text-sm text-yellow-500">未配置</p><p class="text-xs text-yellow-300 mt-1">请先配置摄像头</p></div>';
                        }
                    } else {
                        console.error('未找到摄像头feed元素:', `camera-${cameraId}-feed`);
                    }
                }, 100);
            } else {
                // 无配置
                const feedElement = document.getElementById(`camera-${cameraId}-feed`);
                if (feedElement) {
                    console.log('无配置，显示无配置状态');
                    feedElement.innerHTML = '<div class="flex flex-col items-center justify-center h-full"><i class="fa fa-video-camera text-6xl text-red-500 mb-2"></i><p class="text-sm text-red-500">无配置</p><p class="text-xs text-red-300 mt-1">请先配置摄像头</p></div>';
                } else {
                    console.error('未找到摄像头feed元素:', `camera-${cameraId}-feed`);
                }
                // 更新状态
                updateCameraStatus(cameraId);
            }
            // 显示刷新成功消息
            alert(`摄像头 ${cameraId} 已刷新并启用，视频流已显示`);
            console.log(`摄像头 ${cameraId} 已刷新并启用，加载了上一次的配置`);
        }

        // 停用摄像头
        function disableCamera(cameraId) {
            console.log('停用摄像头', cameraId);
            // 加载当前配置
            const config = loadCameraConfigFromStorage(cameraId);
            if (config) {
                // 更新配置状态为离线
                config.status = 'offline';
                cameraConfigs[cameraId] = config;
                // 保存更新后的配置
                localStorage.setItem(`camera-${cameraId}-config`, JSON.stringify(config));
                // 更新状态和画面
                updateCameraStatus(cameraId);
                updateCameraFeed(cameraId);
                // 显示停用成功消息
                alert(`摄像头 ${cameraId} 已成功停用`);
            }
        }

        // 全屏显示
        function toggleFullscreen(elementId) {
            const element = document.getElementById(elementId);
            if (!element) return;

            if (!document.fullscreenElement) {
                if (element.requestFullscreen) {
                    element.requestFullscreen();
                } else if (element.webkitRequestFullscreen) {
                    element.webkitRequestFullscreen();
                } else if (element.msRequestFullscreen) {
                    element.msRequestFullscreen();
                }
            } else {
                if (document.exitFullscreen) {
                    document.exitFullscreen();
                } else if (document.webkitExitFullscreen) {
                    document.webkitExitFullscreen();
                } else if (document.msExitFullscreen) {
                    document.msExitFullscreen();
                }
            }
        }

        // 打开摄像头设置模态对话框
        function openCameraSettings(cameraId) {
            console.log('打开摄像头设置', cameraId);
            // 显示模态对话框
            const modal = document.getElementById('camera-settings-modal');
            if (modal) {
                modal.classList.remove('hidden');
                // 设置当前选中的摄像头
                const cameraSelect = document.getElementById('camera-select');
                if (cameraSelect) {
                    cameraSelect.value = cameraId;
                    loadCameraConfig(cameraId);
                    // 更新接口参数显示
                    updateInterfaceOptions();
                }
            }
        }

        // 关闭摄像头设置模态对话框
        function closeCameraSettingsModal() {
            const modal = document.getElementById('camera-settings-modal');
            if (modal) {
                modal.classList.add('hidden');
                // 停止测试视频
                stopTestVideo();
            }
        }

        // 根据接口类型更新参数选项
        function updateInterfaceOptions() {
            const interfaceType = document.getElementById('camera-interface').value;
            const localOptions = document.getElementById('local-camera-options');
            const networkOptions = document.getElementById('network-camera-options');
            const cameraUrl = document.getElementById('camera-url');

            if (localOptions && networkOptions && cameraUrl) {
                if (interfaceType === 'local') {
                    localOptions.classList.remove('hidden');
                    networkOptions.classList.add('hidden');
                    cameraUrl.placeholder = '本地摄像头';
                    cameraUrl.disabled = true;
                } else {
                    localOptions.classList.add('hidden');
                    networkOptions.classList.remove('hidden');
                    if (interfaceType === 'rtsp') {
                        cameraUrl.placeholder = 'rtsp://username:password@ip:port/stream';
                    } else if (interfaceType === 'http') {
                        cameraUrl.placeholder = 'http://ip:port/video';
                    } else if (interfaceType === 'onvif') {
                        cameraUrl.placeholder = 'http://ip:port/onvif';
                    }
                    cameraUrl.disabled = false;
                }
            }
        }

        // 扫描接口
        function scanInterfaces() {
            const interfaceType = document.getElementById('camera-interface').value;
            const scanButton = document.getElementById('scan-interfaces-button');
            const cameraUrl = document.getElementById('camera-url');
            const localCameraDevice = document.getElementById('local-camera-device');

            if (scanButton) {
                // 禁用扫描按钮并显示加载状态
                scanButton.disabled = true;
                scanButton.innerHTML = '<i class="fa fa-spinner fa-spin mr-1"></i> 扫描中...';

                if (interfaceType === 'local') {
                    // 扫描本地摄像头
                    scanLocalCameras()
                        .then(() => {
                            // 恢复扫描按钮状态
                            scanButton.disabled = false;
                            scanButton.innerHTML = '<i class="fa fa-search mr-1"></i> 扫描';
                        })
                        .catch(() => {
                            // 恢复扫描按钮状态
                            scanButton.disabled = false;
                            scanButton.innerHTML = '<i class="fa fa-search mr-1"></i> 扫描';
                        });
                } else {
                    // 网络摄像头扫描（模拟）
                    setTimeout(() => {
                        // 恢复扫描按钮状态
                        scanButton.disabled = false;
                        scanButton.innerHTML = '<i class="fa fa-search mr-1"></i> 扫描';
                        alert('网络摄像头扫描完成，请手动输入设备地址');
                    }, 2000);
                }
            }
        }

        // 扫描本地摄像头
        function scanLocalCameras() {
            return new Promise((resolve, reject) => {
                if (!navigator.mediaDevices || !navigator.mediaDevices.enumerateDevices) {
                    alert('浏览器不支持摄像头设备枚举');
                    reject();
                    return;
                }

                navigator.mediaDevices.enumerateDevices()
                    .then(devices => {
                        const videoDevices = devices.filter(device => device.kind === 'videoinput');
                        const localCameraDevice = document.getElementById('local-camera-device');

                        if (localCameraDevice) {
                            // 清空现有选项
                            localCameraDevice.innerHTML = '<option value="">请选择摄像头</option>';
                            
                            // 添加检测到的摄像头
                            videoDevices.forEach((device, index) => {
                                const option = document.createElement('option');
                                option.value = device.deviceId;
                                option.textContent = `摄像头 ${index + 1}: ${device.label || '未知设备'}`;
                                localCameraDevice.appendChild(option);
                            });

                            if (videoDevices.length > 0) {
                                alert(`检测到 ${videoDevices.length} 个本地摄像头`);
                            } else {
                                alert('未检测到本地摄像头');
                            }
                        }
                        resolve();
                    })
                    .catch(err => {
                        console.error('枚举设备失败:', err);
                        alert('无法扫描本地摄像头，请检查权限设置');
                        reject();
                    });
            });
        }

        // 测试视频
        function testVideo() {
            console.log('测试视频按钮被点击');
            
            // 获取必要的DOM元素
            const testContainer = document.getElementById('test-video-container');
            const testButton = document.getElementById('test-video-button');
            const stopButton = document.getElementById('stop-test-button');
            const cameraInterface = document.getElementById('camera-interface');
            const cameraUrl = document.getElementById('camera-url');
            const localCameraDevice = document.getElementById('local-camera-device');
            
            console.log('测试视频元素:', {
                testContainer: !!testContainer,
                testButton: !!testButton,
                stopButton: !!stopButton,
                cameraInterface: !!cameraInterface,
                cameraUrl: !!cameraUrl,
                localCameraDevice: !!localCameraDevice
            });

            // 检查必要的DOM元素
            if (!testContainer || !testButton || !stopButton || !cameraInterface) {
                console.error('缺少必要的DOM元素');
                return;
            }

            // 禁用测试按钮，启用停止按钮
            testButton.disabled = true;
            stopButton.disabled = false;

            // 获取接口类型
            const interfaceType = cameraInterface.value;
            console.log('接口类型:', interfaceType);

            // 显示对应视频流
            if (interfaceType === 'local') {
                // 本地摄像头测试
                console.log('启动本地摄像头测试');
                testContainer.innerHTML = '<div class="flex flex-col items-center justify-center h-full"><i class="fa fa-spinner fa-spin text-6xl text-green-500 mb-4"></i><p class="text-green-500">正在请求摄像头权限...</p><p class="text-green-300 text-sm mt-2">请在浏览器弹出的权限请求中点击"允许"</p></div>';
                
                // 延迟一下，让用户看到权限请求提示
                setTimeout(() => {
                    startLocalCamera(testContainer);
                }, 500);
            } else if (cameraUrl && cameraUrl.value) {
                // 网络摄像头测试 - 显示真实视频流或模拟流
                console.log('显示网络摄像头视频流:', cameraUrl.value);
                testContainer.innerHTML = '<div class="flex flex-col items-center justify-center h-full"><i class="fa fa-spinner fa-spin text-6xl text-blue-500 mb-4"></i><p class="text-blue-500">正在连接网络摄像头...</p></div>';
                
                // 模拟网络摄像头连接
                setTimeout(() => {
                    // 实际项目中，这里应该使用真实的视频流URL
                    const imgUrl = `https://trae-api-cn.mchost.guru/api/ide/v1/text_to_image?prompt=security%20camera%20feed%20live%20testing&image_size=landscape_16_9`;
                    testContainer.innerHTML = `<img src="${imgUrl}" class="w-full h-full object-cover rounded-xl animate-pulse">`;
                    
                    // 启用摄像头按钮
                    const enableButton = document.getElementById('enable-camera-button');
                    if (enableButton) {
                        enableButton.disabled = false;
                    }
                }, 1500);
            } else {
                // 未配置URL
                console.log('未配置视频地址');
                testContainer.innerHTML = '<div class="flex flex-col items-center justify-center h-full"><i class="fa fa-exclamation-circle text-4xl text-yellow-500 mb-4"></i><p class="text-yellow-500">请输入视频地址</p></div>';
                testButton.disabled = false;
                stopButton.disabled = true;
            }
        }

        // 启动本地摄像头
        function startLocalCamera(container) {
            console.log('启动本地摄像头');
            
            try {
                // 停止之前的流
                if (cameraStream) {
                    console.log('停止之前的摄像头流');
                    cameraStream.getTracks().forEach(track => track.stop());
                    cameraStream = null;
                }

                // 检查浏览器支持
                if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
                    console.error('浏览器不支持摄像头访问');
                    container.innerHTML = '<div class="flex flex-col items-center justify-center h-full"><i class="fa fa-exclamation-circle text-4xl text-red-500 mb-4"></i><p class="text-red-500">浏览器不支持摄像头访问</p></div>';
                    return;
                }

                // 获取选择的摄像头设备
                const localCameraDevice = document.getElementById('local-camera-device');
                const deviceId = localCameraDevice ? localCameraDevice.value : '';
                console.log('选择的摄像头设备:', deviceId || '默认设备');

                // 设置摄像头约束
                const constraints = { video: true, audio: false };
                if (deviceId) {
                    constraints.video = { deviceId: { exact: deviceId } };
                }

                console.log('请求摄像头权限:', constraints);
                
                // 设置超时处理，防止一直显示正在连接
                const timeoutId = setTimeout(() => {
                    console.error('摄像头连接超时');
                    container.innerHTML = '<div class="flex flex-col items-center justify-center h-full"><i class="fa fa-exclamation-circle text-4xl text-red-500 mb-4"></i><p class="text-red-500">摄像头连接超时</p><p class="text-red-300 text-sm mt-2">请检查：1.浏览器权限设置 2.摄像头是否被其他应用占用 3.摄像头设备是否正常</p></div>';
                }, 10000); // 10秒超时

                // 请求使用摄像头
                navigator.mediaDevices.getUserMedia(constraints)
                    .then(stream => {
                        // 清除超时
                        clearTimeout(timeoutId);
                        console.log('成功获取摄像头流');
                        cameraStream = stream;
                        
                        // 创建视频元素
                        const video = document.createElement('video');
                        video.srcObject = stream;
                        video.autoplay = true;
                        video.muted = true;
                        video.className = 'w-full h-full object-cover rounded-xl';
                        
                        // 清空容器并添加视频元素
                        container.innerHTML = '';
                        container.appendChild(video);
                        console.log('本地摄像头视频已显示');
                        
                        // 启用摄像头按钮
                        const enableButton = document.getElementById('enable-camera-button');
                        if (enableButton) {
                            enableButton.disabled = false;
                        }
                    })
                    .catch(err => {
                        // 清除超时
                        clearTimeout(timeoutId);
                        console.error('无法访问摄像头:', err);
                        let errorMessage = '无法访问摄像头';
                        
                        if (err.name === 'NotAllowedError') {
                            errorMessage = '摄像头权限被拒绝，请检查浏览器权限设置';
                        } else if (err.name === 'NotFoundError') {
                            errorMessage = '未找到摄像头设备';
                        } else if (err.name === 'NotReadableError') {
                            errorMessage = '摄像头被其他应用占用';
                        } else if (err.name === 'OverconstrainedError') {
                            errorMessage = '摄像头设备不支持指定的参数';
                        } else if (err.name === 'AbortError') {
                            errorMessage = '摄像头访问被中止';
                        }
                        
                        container.innerHTML = `<div class="flex flex-col items-center justify-center h-full"><i class="fa fa-exclamation-circle text-4xl text-red-500 mb-4"></i><p class="text-red-500">${errorMessage}</p></div>`;
                        console.log('显示错误信息:', errorMessage);
                    });
            } catch (error) {
                console.error('启动本地摄像头失败:', error);
                container.innerHTML = '<div class="flex flex-col items-center justify-center h-full"><i class="fa fa-exclamation-circle text-4xl text-red-500 mb-4"></i><p class="text-red-500">启动摄像头时发生错误</p></div>';
            }
        }

        // 停止测试视频
        function stopTestVideo() {
            console.log('停止测试视频按钮被点击');
            const testContainer = document.getElementById('test-video-container');
            const testButton = document.getElementById('test-video-button');
            const stopButton = document.getElementById('stop-test-button');
            const enableButton = document.getElementById('enable-camera-button');

            console.log('停止测试视频参数:', {
                testContainer: !!testContainer,
                testButton: !!testButton,
                stopButton: !!stopButton,
                enableButton: !!enableButton,
                cameraStream: !!cameraStream
            });

            if (!testContainer || !testButton || !stopButton) {
                console.error('缺少必要的DOM元素');
                return;
            }

            // 停止摄像头流
            if (cameraStream) {
                console.log('停止摄像头流');
                cameraStream.getTracks().forEach(track => track.stop());
                cameraStream = null;
            }

            // 启用测试按钮，禁用停止按钮
            testButton.disabled = false;
            if (enableButton) {
                enableButton.disabled = true;
            }
            stopButton.disabled = true;

            // 恢复默认显示
            testContainer.innerHTML = '<i class="fa fa-video-camera text-6xl text-video/30"></i>';
            console.log('测试视频已停止');
        }



        // 更新摄像头状态
        function updateCameraStatus(cameraId) {
            const statusElement = document.getElementById(`camera-${cameraId}-status`);
            if (!statusElement) return;

            // 获取摄像头配置
            const config = cameraConfigs[cameraId] || loadCameraConfigFromStorage(cameraId);
            
            // 根据配置和实际情况更新状态
            let statusText = '在线';
            let statusClass = 'bg-green-500/20 text-green-400';
            
            if (!config) {
                statusText = '未配置';
                statusClass = 'bg-yellow-500/20 text-yellow-400';
            } else if (config.status === 'offline') {
                statusText = '离线';
                statusClass = 'bg-gray-500/20 text-gray-400';
            } else if (config.status === 'error') {
                statusText = '故障';
                statusClass = 'bg-red-500/20 text-red-400';
            } else if (config.interface === 'local') {
                // 本地摄像头状态检测
                statusText = '在线';
                statusClass = 'bg-green-500/20 text-green-400';
            } else if (!config.url) {
                statusText = '未配置';
                statusClass = 'bg-yellow-500/20 text-yellow-400';
            }
            
            statusElement.textContent = statusText;
            statusElement.className = statusClass + ' px-3 py-1 rounded-full text-sm font-medium';
        }

        // 更新摄像头画面
        function updateCameraFeed(cameraId) {
            const feedElement = document.getElementById(`camera-${cameraId}-feed`);
            if (!feedElement) {
                console.error('找不到摄像头画面元素:', `camera-${cameraId}-feed`);
                return;
            }

            // 获取摄像头配置
            const config = cameraConfigs[cameraId] || loadCameraConfigFromStorage(cameraId);
            
            console.log('更新摄像头画面:', cameraId, config);
            
            // 根据配置显示对应视频流
            if (config) {
                if (config.interface === 'local') {
                    // 本地摄像头预览
                    feedElement.innerHTML = '<div class="flex flex-col items-center justify-center h-full"><i class="fa fa-video-camera text-6xl text-green-500 mb-2"></i><p class="text-sm text-green-500">本地摄像头</p><p class="text-xs text-green-300 mt-1">点击刷新启用</p></div>';
                } else if (config.url) {
                    // 网络摄像头预览 - 显示视频流或模拟流
                    const imgUrl = `https://trae-api-cn.mchost.guru/api/ide/v1/text_to_image?prompt=security%20camera%20feed%20live%20monitoring&image_size=landscape_16_9`;
                    feedElement.innerHTML = `<img src="${imgUrl}" class="w-full h-full object-cover rounded-xl">`;
                } else {
                    // 未配置URL
                    feedElement.innerHTML = '<div class="flex flex-col items-center justify-center h-full"><i class="fa fa-video-camera text-6xl text-yellow-500 mb-2"></i><p class="text-sm text-yellow-500">未配置</p></div>';
                }
            } else {
                // 默认显示摄像头图标
                feedElement.innerHTML = '<div class="flex flex-col items-center justify-center h-full"><i class="fa fa-video-camera text-6xl text-video/30 mb-2"></i><p class="text-sm text-video/30">未配置</p></div>';
            }
        }

        // 保存摄像头配置
        function saveCameraConfig() {
            const cameraId = document.getElementById('camera-select').value;
            const interfaceType = document.getElementById('camera-interface').value;
            const cameraUrl = document.getElementById('camera-url').value;
            
            console.log('保存摄像头配置:', {
                cameraId: cameraId,
                interfaceType: interfaceType,
                cameraUrl: cameraUrl
            });
            
            const config = {
                status: 'online', // 保存后自动设置为在线状态
                interface: interfaceType,
                url: cameraUrl,
                username: document.getElementById('camera-username').value,
                password: document.getElementById('camera-password').value,
                resolution: document.getElementById('camera-resolution').value,
                fps: document.getElementById('camera-fps').value,
                connectionTimeout: document.getElementById('connection-timeout') ? parseInt(document.getElementById('connection-timeout').value) : 10
            };

            // 添加本地摄像头特有配置
            if (interfaceType === 'local') {
                config.localDeviceId = document.getElementById('local-camera-device').value;
                console.log('本地摄像头设备ID:', config.localDeviceId);
            }

            // 保存到本地存储
            localStorage.setItem(`camera-${cameraId}-config`, JSON.stringify(config));
            cameraConfigs[cameraId] = config;
            console.log('配置已保存到本地存储:', config);

            // 更新状态
            updateCameraStatus(cameraId);

            // 关闭模态对话框
            closeCameraSettingsModal();

            // 延迟更新视频显示，确保模态对话框关闭后再更新
            setTimeout(() => {
                console.log('更新主页面视频显示:', cameraId);
                const feedElement = document.getElementById(`camera-${cameraId}-feed`);
                if (feedElement) {
                    console.log('找到摄像头feed元素:', `camera-${cameraId}-feed`);
                    if (interfaceType === 'local') {
                        // 本地摄像头 - 真正启动视频流
                        console.log('启动本地摄像头视频流');
                        startLocalCameraFeed(feedElement, config.localDeviceId);
                    } else if (cameraUrl) {
                        // 网络摄像头
                        console.log('显示网络摄像头视频流:', cameraUrl);
                        const imgUrl = `https://trae-api-cn.mchost.guru/api/ide/v1/text_to_image?prompt=security%20camera%20feed%20live%20video%20stream&image_size=landscape_16_9`;
                        feedElement.innerHTML = `<img src="${imgUrl}" class="w-full h-full object-cover rounded-xl">`;
                    } else {
                        // 未配置URL
                        console.log('未配置URL，显示未配置状态');
                        feedElement.innerHTML = '<div class="flex flex-col items-center justify-center h-full"><i class="fa fa-video-camera text-6xl text-yellow-500 mb-2"></i><p class="text-sm text-yellow-500">未配置</p><p class="text-xs text-yellow-300 mt-1">请配置视频地址</p></div>';
                    }
                } else {
                    console.error('未找到摄像头feed元素:', `camera-${cameraId}-feed`);
                }
            }, 100);

            // 显示保存成功信息
            alert(`摄像头 ${cameraId} 配置已保存并启动，视频流已在主页面显示`);
        }

        // 启动本地摄像头视频流
        function startLocalCameraFeed(container, deviceId) {
            console.log('启动本地摄像头视频流:', deviceId);
            
            try {
                // 停止之前的流
                if (cameraStream) {
                    console.log('停止之前的摄像头流');
                    cameraStream.getTracks().forEach(track => track.stop());
                    cameraStream = null;
                }

                // 检查浏览器支持
                if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
                    console.error('浏览器不支持摄像头访问');
                    container.innerHTML = '<div class="flex flex-col items-center justify-center h-full"><i class="fa fa-exclamation-circle text-4xl text-red-500 mb-2"></i><p class="text-sm text-red-500">浏览器不支持摄像头访问</p></div>';
                    return;
                }

                // 设置摄像头约束
                const constraints = { video: true, audio: false };
                if (deviceId) {
                    constraints.video = { deviceId: { exact: deviceId } };
                }

                console.log('请求摄像头权限:', constraints);
                
                // 设置超时处理
                const timeoutId = setTimeout(() => {
                    console.error('摄像头连接超时');
                    container.innerHTML = '<div class="flex flex-col items-center justify-center h-full"><i class="fa fa-exclamation-circle text-4xl text-red-500 mb-2"></i><p class="text-sm text-red-500">摄像头连接超时</p><p class="text-xs text-red-300 mt-1">请检查权限设置</p></div>';
                }, 10000);

                // 请求使用摄像头
                navigator.mediaDevices.getUserMedia(constraints)
                    .then(stream => {
                        // 清除超时
                        clearTimeout(timeoutId);
                        console.log('成功获取摄像头流');
                        cameraStream = stream;
                        
                        // 创建视频元素
                        const video = document.createElement('video');
                        video.srcObject = stream;
                        video.autoplay = true;
                        video.muted = true;
                        video.className = 'w-full h-full object-cover rounded-xl';
                        
                        // 清空容器并添加视频元素
                        container.innerHTML = '';
                        container.appendChild(video);
                        console.log('本地摄像头视频已显示');
                    })
                    .catch(err => {
                        // 清除超时
                        clearTimeout(timeoutId);
                        console.error('无法访问摄像头:', err);
                        let errorMessage = '无法访问摄像头';
                        
                        if (err.name === 'NotAllowedError') {
                            errorMessage = '摄像头权限被拒绝，请检查浏览器权限设置';
                        } else if (err.name === 'NotFoundError') {
                            errorMessage = '未找到摄像头设备';
                        } else if (err.name === 'NotReadableError') {
                            errorMessage = '摄像头被其他应用占用';
                        }
                        
                        container.innerHTML = `<div class="flex flex-col items-center justify-center h-full"><i class="fa fa-exclamation-circle text-4xl text-red-500 mb-2"></i><p class="text-sm text-red-500">${errorMessage}</p></div>`;
                    });
            } catch (error) {
                console.error('启动本地摄像头失败:', error);
                container.innerHTML = '<div class="flex flex-col items-center justify-center h-full"><i class="fa fa-exclamation-circle text-4xl text-red-500 mb-2"></i><p class="text-sm text-red-500">启动摄像头时发生错误</p></div>';
            }
        }

        // 加载摄像头配置
        function loadCameraConfig(cameraId) {
            const config = loadCameraConfigFromStorage(cameraId);
            if (!config) return;

            document.getElementById('camera-status').value = config.status || 'online';
            document.getElementById('camera-interface').value = config.interface || 'rtsp';
            document.getElementById('camera-url').value = config.url || '';
            document.getElementById('camera-username').value = config.username || '';
            document.getElementById('camera-password').value = config.password || '';
            document.getElementById('camera-resolution').value = config.resolution || '1920x1080';
            document.getElementById('camera-fps').value = config.fps || '30';
            
            // 加载连接超时设置
            if (document.getElementById('connection-timeout')) {
                document.getElementById('connection-timeout').value = config.connectionTimeout || 10;
            }
            
            // 加载本地摄像头设备
            if (document.getElementById('local-camera-device')) {
                document.getElementById('local-camera-device').value = config.localDeviceId || '';
            }
        }

        // 从本地存储加载摄像头配置
        function loadCameraConfigFromStorage(cameraId) {
            const configStr = localStorage.getItem(`camera-${cameraId}-config`);
            if (!configStr) return null;
            
            try {
                return JSON.parse(configStr);
            } catch (e) {
                console.error('解析摄像头配置失败:', e);
                return null;
            }
        }

        // 初始化所有摄像头
        function initCameras() {
            // 初始化所有摄像头的状态和画面
            for (let i = 1; i <= 4; i++) {
                // 从本地存储加载配置
                const config = loadCameraConfigFromStorage(i);
                if (config) {
                    console.log('初始化摄像头配置:', i, config);
                    cameraConfigs[i] = config;
                    // 直接显示视频流
                    const feedElement = document.getElementById(`camera-${i}-feed`);
                    if (feedElement) {
                        if (config.interface === 'local') {
                            // 本地摄像头
                            feedElement.innerHTML = '<div class="flex flex-col items-center justify-center h-full"><i class="fa fa-video-camera text-6xl text-green-500 mb-2"></i><p class="text-sm text-green-500">本地摄像头</p><p class="text-xs text-green-300 mt-1">视频流已启用</p></div>';
                        } else if (config.url) {
                            // 网络摄像头
                            const imgUrl = `https://trae-api-cn.mchost.guru/api/ide/v1/text_to_image?prompt=security%20camera%20feed%20live%20video&image_size=landscape_16_9`;
                            feedElement.innerHTML = `<img src="${imgUrl}" class="w-full h-full object-cover rounded-xl">`;
                        }
                    }
                }
                updateCameraStatus(i);
                updateCameraFeed(i);
            }
        }

        // 页面加载完成后初始化
        document.addEventListener('DOMContentLoaded', function() {
            // 初始化所有摄像头
            initCameras();

            // 保存摄像头配置按钮事件
            const saveCameraConfigButton = document.getElementById('save-camera-config');
            if (saveCameraConfigButton) {
                saveCameraConfigButton.addEventListener('click', function() {
                    saveCameraConfig();
                });
            }

            // 加载摄像头配置按钮事件
            const loadCameraConfigButton = document.getElementById('load-camera-config');
            if (loadCameraConfigButton) {
                loadCameraConfigButton.addEventListener('click', function() {
                    const cameraId = document.getElementById('camera-select').value;
                    loadCameraConfig(cameraId);
                    updateInterfaceOptions();
                });
            }

            // 摄像头选择变更事件
            const cameraSelect = document.getElementById('camera-select');
            if (cameraSelect) {
                cameraSelect.addEventListener('change', function() {
                    const cameraId = this.value;
                    loadCameraConfig(cameraId);
                    updateInterfaceOptions();
                });
            }

            // 接口类型变更事件
            const cameraInterface = document.getElementById('camera-interface');
            if (cameraInterface) {
                cameraInterface.addEventListener('change', function() {
                    updateInterfaceOptions();
                });
            }

            // 扫描接口按钮事件
            const scanInterfacesButton = document.getElementById('scan-interfaces-button');
            if (scanInterfacesButton) {
                scanInterfacesButton.addEventListener('click', function() {
                    scanInterfaces();
                });
            }

            // 测试视频按钮事件
            const testVideoButton = document.getElementById('test-video-button');
            console.log('测试视频按钮元素:', testVideoButton);
            if (testVideoButton) {
                console.log('绑定测试视频按钮点击事件');
                testVideoButton.addEventListener('click', function() {
                    console.log('测试视频按钮点击事件触发');
                    testVideo();
                });
            } else {
                console.error('找不到测试视频按钮元素');
            }

            // 停止测试按钮事件
            const stopTestButton = document.getElementById('stop-test-button');
            if (stopTestButton) {
                stopTestButton.addEventListener('click', function() {
                    stopTestVideo();
                });
            }

            // 摄像头按钮事件
            for (let i = 1; i <= 4; i++) {
                // 刷新按钮
                const refreshButton = document.getElementById(`refresh-camera-${i}`);
                if (refreshButton) {
                    refreshButton.addEventListener('click', function() {
                        refreshCamera(i);
                    });
                }

                // 停用按钮
                const disableButton = document.getElementById(`disable-camera-${i}`);
                if (disableButton) {
                    disableButton.addEventListener('click', function() {
                        disableCamera(i);
                    });
                }

                // 全屏按钮
                const fullscreenButton = document.getElementById(`fullscreen-camera-${i}`);
                if (fullscreenButton) {
                    fullscreenButton.addEventListener('click', function() {
                        toggleFullscreen(`camera-${i}-feed`);
                    });
                }

                // 设置按钮
                const settingsButton = document.getElementById(`settings-camera-${i}`);
                if (settingsButton) {
                    settingsButton.addEventListener('click', function() {
                        openCameraSettings(i);
                    });
                }
            }
        });
</script>
{% endblock %}